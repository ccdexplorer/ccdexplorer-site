{% include 'base/tabulator/tabulator-custom-formatters.html' %}
{% set ccd_tabulator_table ='latest_transactions'%}
{% set REFRESH = 5_000%}
<div class="row">
  <div class="col">
  <span class="text-uppercase sm-text text-secondary-emphasis">Latest Transactions</span>
  </div>
{% include 'base/tabulator/timer-display.html' %}
</div>
<div id="{{ccd_tabulator_table}}" ></div>
<script>
  const {{ccd_tabulator_table}}_columns = [
  {
        title: "Hash", field: "hash", 
        minWidth: 60,
        maxWidth: 60,
        responsive: 0,
        sorter: "number",
        formatter: "html",
        accessorDownload: (value, data) => data.hash_download,
        headerSort: false,
        hozAlign: "left", headerHozAlign: "left",
        
      },
      {
        title: "Timestamp", field: "timestamp", 
        minWidth: 100,
        maxWidth: 100,
        responsive: 50,
        formatter: "html",
        headerSort:false,
        titleDownload:"Timestamp",
        accessorDownload: (value, data) => data.transaction_block_info_slot_time_download,
        hozAlign: "right", headerHozAlign: "right",
        
      },
      {
        title: "Cost", field: "transaction_account_transaction_cost", hozAlign: "right", headerHozAlign: "right", 
        responsive: 100,
        minWidth: 100,
        maxWidth: 100, 
        sorter: "number",
        headerSort: false,
        accessorDownload: (value, data) => data.transaction_account_transaction_cost/1000000,
        formatter: microCCDFormatter,
      },
      {
        title: "Primary Type", field: "transaction_type_contents", hozAlign: "left", headerHozAlign: "left", 
        responsive: 0,
        minWidth: 170,
        // maxWidth: 170, 
        formatter:txTypeFormatter,
        headerSort: false,
        
      },
      {
        title: "", field: "type_additional_info", hozAlign: "right", 
        responsive: 70,
        minWidth: 200,
        maxWidth: 200, 
        formatter: "html",
        accessorDownload: (value, data) => data.type_additional_info_download,
        headerSort: false,
        
      },
      {
        title: "Block", field: "block_height", hozAlign: "right", headerHozAlign: "right", 
        responsive: 90,
        minWidth: 120,
        maxWidth: 130, 
        formatter: "html",
        accessorDownload: (value, data) => data.block_height_download,
        headerSort: false,
        
      },
      {
        
        title: "Sender", field: "sender", headerHozAlign:"right", hozAlign: "right", 
        responsive: 30,
        minWidth: 120,
        // maxWidth: 180, 
        formatter: "html",
        accessorDownload: (value, data) => data.sender_download,
        headerSort: false,
        
      }

    ];

  
  
  window["{{ccd_tabulator_table}}_columns"] = {{ccd_tabulator_table}}_columns;

  window["{{ccd_tabulator_table}}_table"] = new Tabulator("#{{ccd_tabulator_table}}", {
  layout: "fitColumns",
  height: "600px",
  responsiveLayout: "hide",
  ajaxURL: "/{{net}}/ajax_last_transactions_own_page",              // your paged endpoint
  initialSort: [{column:"block_height", dir:"desc"}],
  paginationSize: 50,                // rows per “page”
  progressiveLoad: "scroll",         // infinite scroll mode
  progressiveLoadScrollMargin: 300,  // trigger next load 300px from bottom
  columns: window["{{ccd_tabulator_table}}_columns"],
});
window["{{ccd_tabulator_table}}_table"].on("renderComplete", function () {
  document.querySelectorAll(".tabulator-col-title").forEach(el => {
    el.classList.add("sm-text");
  });
});
async function pollNewTransactions(){
    const data = window["{{ccd_tabulator_table}}_table"].getData();
    const since = data.length ? data[0].block_height_since : 0;
    nextRefresh = Date.now() + REFRESH_INTERVAL;
    
    try {
      const resp = await fetch(`/{{net}}/ajax_transactions/new?height=${since}`, {
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      if (!resp.ok) throw new Error(resp.statusText);
      const newBlocks = await resp.json();

      if (newBlocks.length){
        await window["{{ccd_tabulator_table}}_table"].addData(newBlocks, true);
      }
    } catch (e) {
      
    }
  }
  
</script>
{% include 'base/tabulator/timer-js.html' %}
<script>
  setInterval(pollNewTransactions, {{REFRESH}});
</script>
