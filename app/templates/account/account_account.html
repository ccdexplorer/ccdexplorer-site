{% extends "base/base.html" %}

{% block js %}
<script src="/node/plotly.js-strict-dist-min/plotly-strict.min.js"></script>

<script>
let validatorTabLoaded = false;

document.addEventListener("DOMContentLoaded", function () {
  const validatorTabButton = document.querySelector('#pills-validator-tab');

  validatorTabButton.addEventListener('shown.bs.tab', function () {
    if (!validatorTabLoaded) {
      fetch("/account/validator-tab-content/{{ net }}/{{ account_id }}")
        .then(response => response.text())
        .then(html => {
          const container = document.getElementById('validator-tab-content');
          container.innerHTML = html;
          if (window.htmx) {
            htmx.process(container);
          }
          if (typeof init_validator_tally_table === "function") {
            init_validator_tally_table();
          }
          if (typeof init_validator_transactions_table === "function") {
            init_validator_transactions_table();
          }
          
        })
        .catch(err => {
          document.getElementById('validator-tab-content').innerHTML = "<p class='text-danger'>Failed to load validator tab.</p>";
          console.error(err);
        });

      validatorTabLoaded = true;
    }
  });
});
</script>
{% endblock %}

{% block ogp %}
<meta property="og:title" content="Account {{account_index}} on Concordium {{net}}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="{{env.SITE_URL}}/{{net}}/account/{{account_index}}" />
{% endblock %}

{% block content %}

{% if error %}
<p>An error occured: <b>{{error.errorMessage}}</b></p>
{% else %}
{% if show_tab %}
{% set show_tab_list = show_tab.split('-') %}
{% else %}
{% set show_tab_list = [] %}

{% endif %}
<script>
  // Create a new URL object
let url = new URL(window.location.href);

// Get the referrer, if there is one
let ref = url.searchParams.get('ref');

// If there's a referrer...
if (ref) {

	// store their ID as a cookie
	document.cookie = `affiliate_id=${ref}; path=/; max-age=${60 * 60 * 24 * 28};`;

	// Remove the query string parameter from the URL
	url.searchParams.delete('ref');
	history.replaceState(history.state, '', url.href);

}

</script>

<!-- Get Transactions -->
<script>
  async function getTransactions(requested_page, total_rows) {
    transactions = document.getElementById('txs');
    var account_id = document.querySelector('.account_id').title;
    url = '/account_transactions/{{net}}/' + account_id + '/' + requested_page + '/' + total_rows + '/' + api_key;
    transactions.innerHTML = '{% include "base/spinner.html" %}'
    await fetch(url)
      .then((response) => {
        return response.text();
      })
      .then((data) => {
        transactions.innerHTML = data;
      })
      .catch(function (error) {
        console.log(error);
      });
  }

  function prev_txs(requested_page, total_rows) {
    getTransactions(requested_page, total_rows)
  };
  function next_txs(requested_page, total_rows) {
    getTransactions(requested_page, total_rows)
  };

  
</script>


<script>
  async function getFungibleVerifiedTokens(requested_page, total_rows) {
    try {
      fungible_verified_tokens = document.getElementById('fungible_verified_tokens');
      var account_id = document.querySelector('.account_id').title;
      url = '/ajax_account_tokens/{{net}}/fungible-verified/' + account_id + '/' + requested_page + '/' + total_rows + '/' + api_key;
      
      fungible_verified_tokens.innerHTML = '{% include "base/spinner.html" %}'
      await fetch(url)
        .then((response) => {
          return response.text();
        })
        .then((data) => {
          fungible_verified_tokens.innerHTML = data;
        })
        .catch(function (error) {
          console.log(error);
        });
    }
  catch (error) {
    
}
  }

  function prev_f_v_tokens(requested_page, total_rows) {
    getFungibleVerifiedTokens(requested_page, total_rows)
  };
  function next_f_v_tokens(requested_page, total_rows) {
    getFungibleVerifiedTokens(requested_page, total_rows)
  };


  async function getNonFungibleVerifiedTokens(requested_page, total_rows) {
    try {
      non_fungible_verified_tokens = document.getElementById('non_fungible_verified_tokens');
      var account_id = document.querySelector('.account_id').title;
      url = '/ajax_account_tokens/{{net}}/non-fungible-verified/' + account_id + '/' + requested_page + '/' + total_rows + '/' + api_key;
      
      non_fungible_verified_tokens.innerHTML = '{% include "base/spinner.html" %}'
      await fetch(url)
        .then((response) => {
          return response.text();
        })
        .then((data) => {
          non_fungible_verified_tokens.innerHTML = data;
        })
        .catch(function (error) {
          console.log(error);
        });
    }
  catch (error) {
    
}
  }

  function prev_n_f_v_tokens(requested_page, total_rows) {
    getNonFungibleVerifiedTokens(requested_page, total_rows)
  };
  function next_n_f_v_tokens(requested_page, total_rows) {
    getNonFungibleVerifiedTokens(requested_page, total_rows)
  };

  
  async function getUnVerifiedTokens(requested_page, total_rows) {
    try {
      unverified_tokens = document.getElementById('unverified_tokens');
      var account_id = document.querySelector('.account_id').title;
      url = '/ajax_account_tokens/{{net}}/unverified/' + account_id + '/' + requested_page + '/' + total_rows + '/' + api_key;
      
      unverified_tokens.innerHTML = '{% include "base/spinner.html" %}'
      await fetch(url)
        .then((response) => {
          return response.text();
        })
        .then((data) => {
          unverified_tokens.innerHTML = data;
        })
        .catch(function (error) {
          console.log(error);
        });
    }
  catch (error) {
    
}
  }

  function prev_un_tokens(requested_page, total_rows) {
    getUnVerifiedTokens(requested_page, total_rows)
  };
  function next_un_tokens(requested_page, total_rows) {
    getUnVerifiedTokens(requested_page, total_rows)
  };

</script>


<script>
  async function getDelegators(requested_page, total_rows) {
    try {
      delegators = document.getElementById('delegators');
      url = '/account_pool_delegators/{{net}}/{{account_index}}/' + requested_page + '/' + total_rows + '/' + api_key;
      delegators.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'
      await fetch(url)
        .then((response) => {
          return response.text();
        })
        .then((data) => {
          delegators.innerHTML = data;
        })
        .catch(function (error) {
          console.log(error);
        });
    } catch (eroor) {}
  }

  function prev_delegators(requested_page, total_rows) {
    getDelegators(requested_page, total_rows)
  };
  function next_delegators(requested_page, total_rows) {
    getDelegators(requested_page, total_rows)
  };

  
</script>


{% include 'base/search_bar_non_home_inclusion.html' %}
    <div class="row row-flex">
      <div class=" col-md-6  col-sm-12">
        <div class="border content curved-border ">
          {% set title= "Account Info" %}{% include 'base/box_title.html' %}
          {% include "account/account_info.html" %}</div>
        
        
      </div>  
      <div class=" col-md-6  col-sm-12">
        <div class="border content curved-border mb-2">
          {% set title= "More Info" %}{% include 'base/box_title.html' %}
          {% include "account/account_more_info.html" %}</div>
        
      </div> 
      
    </div>
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        
        <li class="nav-item" role="presentation">
          <button class="nav-link active explorer bg-secondary-subtle" id="pills-txsfilter-tab" data-bs-toggle="pill" data-bs-target="#pills-txsfilter" type="button" role="tab" aria-controls="pills-txsfilter" aria-selected="true">
            <span class="tab-text-large">Transactions</span><span class="tab-text-small">Txs</span>
        </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link  explorer bg-secondary-subtle" id="pills-creds-tab" data-bs-toggle="pill" data-bs-target="#pills-creds" type="button" role="tab" aria-controls="pills-creds" aria-selected="true">
            <span class="tab-text-large">Credentials</span><span class="tab-text-small">ID</span>
        </button>
        </li>
        {% if tokens_available %}
        <li class="nav-item" role="presentation">
          <button class="nav-link  explorer bg-secondary-subtle" id="tokens-pills-tab" data-bs-toggle="pill" data-bs-target="#pills-tokens" type="button" role="tab" aria-controls="pills-tokens" aria-selected="true">
            <span class="tab-text-large">Tokens</span><span class="tab-text-small">Tokens</span>
        </button>
        </li>
      {% endif %}  
        {% if delegation %}
        <li class="nav-item" role="presentation"></li>
          <button class="nav-link  explorer bg-secondary-subtle" id="pills-delegation-tab" data-bs-toggle="pill" data-bs-target="#pills-delegation" type="button" role="tab" aria-controls="pills-delegation" aria-selected="true">
            <span class="tab-text-large">Delegation</span><span class="tab-text-small">Delegation</span>
        </button>
        </li>
        {% endif %}
        {% if net=='mainnet' %}
          {% if rewards_no_stake %}
          <li class="nav-item" role="presentation"></li>
            <button class="nav-link  explorer bg-secondary-subtle" id="pills-nostake-tab" data-bs-toggle="pill" data-bs-target="#pills-nostake" type="button" role="tab" aria-controls="pills-nostake" aria-selected="true">
              <span class="tab-text-large">Rewards</span><span class="tab-text-small">Rewards</span>
          </button>
          </li>
          {% endif %}
          {% endif %}
        {% if account_is_validator %}
        <li class="nav-item" role="presentation"></li>
          <button class="nav-link  explorer bg-secondary-subtle" id="pills-validator-tab" data-bs-toggle="pill" data-bs-target="#pills-validator" type="button" role="tab" aria-controls="pills-validator" aria-selected="true">
            <span class="tab-text-large">Validator</span><span class="tab-text-small">Validator</span>
        </button>
        </li>
        {% endif %}
        {% if pool %}
        <li class="nav-item" role="presentation"></li>
          <button class="nav-link  explorer bg-secondary-subtle" id="pills-pool-tab" data-bs-toggle="pill" data-bs-target="#pills-pool" type="button" role="tab" aria-controls="pills-pool" aria-selected="true">
            <span class="tab-text-large">Pool</span><span class="tab-text-small">Pool</span>
        </button>
        </li>
        {% endif %}
        {% if net == 'mainnet' %}
        <li class="nav-item" role="presentation"></li>
          <button class="nav-link  explorer bg-secondary-subtle" id="pills-analytics-tab" data-bs-toggle="pill" data-bs-target="#pills-analytics" type="button" role="tab" aria-controls="pills-analytics" aria-selected="true">
            <span class="tab-text-large">Analytics</span><span class="tab-text-small">Analytics</span>
        </button>
        </li>
        {% endif %}
</ul>

<div class="tab-content" id="pills-tabContent">
  
  <div class="tab-pane fade show active" id="pills-txsfilter" role="tabpanel" aria-labelledby="pills-txsfilter-tab" tabindex="0">
    <div class="row mt-4">
      <div class=" col-md-12  col-sm-12">
        <div class="border curved-border" >
          <div class="input-box mt-1 d-flex justify-content-start">
                <select 
                  class="form-select form-select-sm search_selector_filter text-end" 
                  id="tx_type_contents_selector"
                  name="tx_type_contents_selector">
                  <option value="all" selected>All</option>
                  <option value="transfer">Transfers</option>
                  <option value="smart_contract">Smart Contracts</option>
                  <option value="identity">Identity</option>
                  <option value="staking">Staking / Delegation</option>
                  <option value="rejected">Rejected TXs</option>
                  <option value="data_registered">Data</option>
                </select>
                    
            </div>
            
            <div id="txsfilter">
              {% include "base/tabulator/tabulator-account-filtered-txs.html" %}
          </div>
          {% set ccd_tabulator_table ='txsfilter'%}
          {% include 'base/tabulator/tabulator-table-download-link.html' %}
          
        </div>
      </div>  
      
    </div>
  </div>
  <div class="tab-pane fade show " id="pills-creds" role="tabpanel" aria-labelledby="pills-creds-tab" tabindex="0">
    <div class="row mt-4">
      <div class=" col-md-12  col-sm-12">
        
          <div class="border curved-border">{% include "account/account_credentials.html" %}</div>
        
      </div>  
      
    </div>
  </div>
  {% if tokens_available %}
  <div class="tab-pane fade show " id="pills-tokens" role="tabpanel" aria-labelledby="pills-tokens-tab" tabindex="0">
    <div class="row row-flex">
        <div id="fungible_verified_tokens"></div>
      
      
        <div id="non_fungible_verified_tokens"></div>
      
      
        <div id="unverified_tokens"></div>
      
    </div>  
      
  </div>
  {% endif %}
  {% if rewards_no_stake %}
  <div class="tab-pane fade show " id="pills-nostake" role="tabpanel" aria-labelledby="pills-nostake-tab" tabindex="0">
    {% include "account/account_rewards_no_stake.html" %}
    {% include "account/account_cooldowns.html"%}
 
</div>
  {% endif %}
  {% if delegation %}
  <div class="tab-pane fade show " id="pills-delegation" role="tabpanel" aria-labelledby="pills-delegation-tab" tabindex="0">
       {% include "account/account_delegation.html" %}
       {% include "account/account_cooldowns.html"%}
  </div>
  {% endif %}
  {% if account_is_validator %}
  <div class="tab-pane fade show " id="pills-validator" role="tabpanel" aria-labelledby="pills-validator-tab" tabindex="0">
    <div id="validator-tab-content">Loading...</div>   
    
    
  </div>
  {% endif %}
  {% if pool %}
  <div class="tab-pane fade show " id="pills-pool" role="tabpanel" aria-labelledby="pills-pool-tab" tabindex="0">
       {% include "pool/pool.html" %}
    
  </div>
  {% endif %}
  {% if net == 'mainnet' %}
    <div class="tab-pane fade show " id="pills-analytics" role="tabpanel" aria-labelledby="pills-analytics-tab" tabindex="0">
      <div class="border content curved-border " >
          {% include "account/account_analytics.html" %}
        </div>  
    </div>
  {% endif %}
 
</div>

<!-- <script>
  function applyTxTypeFilter() {
    const table  = window["txsfilter_table"];
    const select = document.getElementById("tx_type_contents_selector");
    table.setFilter("type", "=", select.value);
    console.log("Setting filter to: " + select.value);
    console.log("Setting data to: " + "{{tabulator_ajax_url}}");
    table.setData("{{tabulator_ajax__filtering_url}}");
  }

  window.addEventListener("load", () => {
    console.log("Applying transaction type filter on load");
    applyTxTypeFilter();
    
  });

  document
    .getElementById("tx_type_contents_selector")
    .addEventListener("change", applyTxTypeFilter);
</script> -->



<script>
window.addEventListener('load', (event) => {
    '{% if account_is_validator %}'
        
        // getDelegators(0, 0);
    '{% endif %}'
    getFungibleVerifiedTokens(0, 0);
    getNonFungibleVerifiedTokens(0,0);
    getUnVerifiedTokens(0,0);
  });
    
</script>
{% endif %}

<!-- Tabulator Tables -->
{% include 'base/tabulator/tabulator-custom-formatters.html' %}

<!-- validator tally -->
{% set ccd_tabulator_table ='validator_tally_table'%}
{% set tabulator_ajax_url = '/account/validator-tally/'+net+'/'+ account_index|string %}
{% set filename='validator-tally-'+ account_index|string+'-'+range(1000,10000)|random|string+'.csv' %}

{% include 'base/tabulator/tabulator-common-options-get.html' %}

<script>
function init_validator_tally_table() {
  const validator_tally_table_columns = [
  {
        title: "Date", field: "date", 
        minWidth: 95,
        // maxWidth: 70,
        responsive: 0,
        
        formatter: ccdClassFormatterForString,
        headerSort: false,
        hozAlign: "left", headerHozAlign: "left",
        
      },
      {
        title: "LP(%)", field: "lp", 
        minWidth: 90,
        maxWidth: 90,
        responsive: 10,
        formatter: LotteryPowerFormatter,
        accessorDownload: (value, data) => data.lp*100,
        headerSort:false,
        hozAlign: "right", headerHozAlign: "right",
        
      },
      {
        title: "Expectation", field: "expectation", 
        minWidth: 120,
        maxWidth: 120,
        responsive: 0,
        formatter: intFormatterRounded,
        headerSort:false,
        hozAlign: "right", headerHozAlign: "right",
        
      },
      {
        title: "Actual", field: "actuals", 
        minWidth: 100,
        maxWidth: 100,
        responsive: 0,
        formatter: intFormatterRounded,
        headerSort:false,
        
        hozAlign: "right", headerHozAlign: "right",
        
      },
      
    ];
  window["validator_tally_table_filename"] = '{{filename}}';

  window["validator_tally_table_table"] = new Tabulator("#validator_tally_table", {
    ...commonTabulatorOptionsGET,
    columns: validator_tally_table_columns,
    ajaxURL: "{{tabulator_ajax_url}}",
    ajaxRequesting: function(url, params){
    return true; // must return true to allow the request
  },
  });

  window["validator_tally_table_table"].on("renderComplete", function () {
    document.querySelectorAll(".tabulator-col-title").forEach(el => {
      el.classList.add("sm-text");
    });
  });
  const downloadBtn = document.getElementById("{{ccd_tabulator_table}}-download-csv");
    if (downloadBtn) {
      document.getElementById("validator-tab-content").addEventListener("click", e => {
  if (e.target.matches("#{{ccd_tabulator_table}}-download-csv")) {
    window.validator_tally_table_table.download(
      "csv",
      window.validator_tally_table_filename,
      { bom: true, downloadDataFormatter: data => data }
    );
  }
});
  }
}
</script>


<!-- validator tally -->

<!-- validator transactions -->
 {% set ccd_tabulator_table ='validator_transactions_table'%}
{% set tabulator_ajax_url = '/account_validator_transactions/'+net+'/'+ account_id%}
{% set filename='validator-transactions-'+ account_index|string+'-'+range(1000,10000)|random|string+'.csv' %}

{% include 'base/tabulator/tabulator-common-options-get.html' %}

<script>
function init_validator_transactions_table() {
  const validator_transactions_table_columns = [
  {
        title: "Hash", field: "hash", 
        minWidth: 60,
        maxWidth: 60,
        responsive: 0,
        sorter: "number",
        formatter: "html",
        accessorDownload: (value, data) => data.hash_download,
        headerSort: false,
        hozAlign: "left", headerHozAlign: "left",
        
      },
      {
        title: "Age", field: "transaction_block_info_slot_time", 
        minWidth: 100,
        maxWidth: 100,
        responsive: 50,
        formatter: isoDateTimeHumanDiff,
        headerSort:false,
        titleDownload:"Timestamp",
        accessorDownload: (value, data) => data.transaction_block_info_slot_time_download,
        hozAlign: "right", headerHozAlign: "right",
        
      },
      {
        
        title: "Event", field: "first_event", headerHozAlign:"right", hozAlign: "right", 
        responsive: 30,
        minWidth: 250,
        // maxWidth: 180, 
        formatter: "html",
        accessorDownload: (value, data) => StripHTMLFormatterOnString(data.first_event),
        headerSort: false,
        
      }
      
    ];
  window["{{ccd_tabulator_table}}_filename"] = '{{filename}}';

  window["validator_transactions_table_table"] = new Tabulator("#validator_transactions_table", {
    ...commonTabulatorOptionsGET,
    columns: validator_transactions_table_columns,
    ajaxURL: "{{tabulator_ajax_url}}",
    ajaxRequesting: function(url, params){
    return true; // must return true to allow the request
  },
  });

  window["validator_transactions_table_table"].on("renderComplete", function () {
    document.querySelectorAll(".tabulator-col-title").forEach(el => {
      el.classList.add("sm-text");
    });
  });
  const downloadBtn = document.getElementById("{{ccd_tabulator_table}}-download-csv");
    if (downloadBtn) {
      document.getElementById("validator-tab-content").addEventListener("click", e => {
  if (e.target.matches("#{{ccd_tabulator_table}}-download-csv")) {
    window["validator_transactions_table_table"].download(
      "csv",
      window["{{ccd_tabulator_table}}_filename"],
      { bom: true, downloadDataFormatter: data => data }
    );
  }
});
  }
}
</script>


<!-- validator transactions -->

{% endblock content %}
