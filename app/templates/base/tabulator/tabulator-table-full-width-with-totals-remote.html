<div id="{{ccd_tabulator_table}}"></div>
<div>
  <a href="#" class="tabulator-download-button" id="download-csv">Download visible rows as CSV</a>
</div>

<script>
  
  window["{{ccd_tabulator_table}}_table"] = new Tabulator("#{{ccd_tabulator_table}}", {
    
      columns: window["{{ccd_tabulator_table}}_columns"],
      layout: "fitColumns",
      responsiveLayout: "hide",
      // pagination: true, 
      paginationMode: "remote", 
      
      paginationSizeSelector: window["{{ccd_tabulator_table}}_size_selector"] || [10, 25, 50, 100],
      paginationSize: (window["{{ccd_tabulator_table}}_size_selector"] || [10, 25, 50, 100])[0],
      paginationButtonCount:3,
      pagination:true,
      paginationCounter: function(pageSize, currentRow, currentPage, totalRows, totalPages) {
          // Humanize totals with Intl.NumberFormat compact notation
          function humanize(num) {
              if (num < 1000) {
                  return num.toLocaleString();
              }
              return new Intl.NumberFormat('en', {
                  notation: 'compact',
                  compactDisplay: 'short',
                  maximumFractionDigits: 1,
              }).format(num);
          }

          // Compute the 1-based range of items on this page
          const startIdx = (currentPage - 1) * pageSize + 1;
          const endIdx = Math.min(currentPage * pageSize, totalRows);
          const range = `${startIdx.toLocaleString()} â€“ ${endIdx.toLocaleString()}`;

          // Choose raw vs. humanized total
          const totalFmt = totalRows < 5000
              ? totalRows.toLocaleString()
              : humanize(totalRows);

          // Final display string
          return `<span class="ccd">${range} of ${totalFmt}</span>`;
      },
      sortMode:"remote",
      ajaxURL: "{{tabulator_ajax_url}}",
      initialSort:[
        {
          column: window["{{ccd_tabulator_table}}_default_sort_field"], 
          dir: window["{{ccd_tabulator_table}}_default_sort_field_direction"]
        }
        
    ],
    rowFormatter: function(row){
  row.getElement().classList.add("sm-text");
},
      ajaxURLGenerator: function (url, config, params) {
        const page = params.page || 1;
        const size = params.size || 10;
        const skip = (page - 1) * size;

        const sorter = params.sort?.[0] || {};
        const sort_key = sorter.field || window["{{ccd_tabulator_table}}_default_sort_field"];
        const direction = sorter.dir || window["{{ccd_tabulator_table}}_default_sort_field_direction"];
        const queryParams = {
          page,
          size,
        };
        if (window["{{ccd_tabulator_table}}_default_sort_field"] !== undefined) {
          queryParams.sort_key = sort_key;
          queryParams.direction = direction;
        }
        const query = new URLSearchParams(queryParams);
        
        return `{{tabulator_ajax_url}}?${query.toString()}`;
      },

  });
  // Right after you build the table:
console.log("Tabulator will load from:", window["{{ccd_tabulator_table}}_table"].options.ajaxURL);
</script>
