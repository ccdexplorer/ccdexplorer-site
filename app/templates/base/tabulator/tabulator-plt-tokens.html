
<!-- PLT -->
 {% set ccd_tabulator_table ='plt_table'%}
{% set tabulator_ajax_url = '/ajax_account_plt_tokens/'+net+'/'+ account_id%}
{% set filename='plt-tokens-'+ account_id+'-'+range(1000,10000)|random|string+'.csv' %}

{% include 'base/tabulator/tabulator-common-options-get.html' %}

<script>
function init_plt_tokens_table() {
  const plt_table_columns = [

      {
        title: "Token", field: "token_display", 
        minWidth: 140,
        // maxWidth: 140,
        responsive: 0,
        accessorDownload: (value, data) => data.token_display_download,
        formatter: "html",
        headerSort: false,
        hozAlign: "left", headerHozAlign: "left",
        
      },
      {
        title: "Token Balance", field: "token_balance_download", 
        visible: false,
        download: true,
        accessorDownload: (value, data) => data.token_balance_download,
        
      },
      {
        
        title: "Value (USD)", field: "token_balance_usd", headerHozAlign:"right", hozAlign: "right", 
        responsive: 0,
        minWidth: 130,
        maxWidth: 130, 
        formatter: "html",
        accessorDownload: (value, data) => data.token_balance_usd_download,
        headerSort: false,
        
      }
      
    ];
  window["{{ccd_tabulator_table}}_filename"] = '{{filename}}';

  window["plt_table"] = new Tabulator("#plt_table", {
    ...commonTabulatorOptionsGET,
    columns: plt_table_columns,
    ajaxURL: "{{tabulator_ajax_url}}",
    ajaxRequesting: function(url, params){
    return true; // must return true to allow the request
  },ajaxResponse: function (url, params, resp) {
      const rows = Array.isArray(resp?.data) ? resp.data : [];
      const last_page = Math.max(1, Number(resp?.last_page ?? 1));
      const last_row  = Math.max(0, Number(resp?.last_row  ?? rows.length));

      const wrap = document.getElementById("{{ccd_tabulator_table}}_wrapper");
      if (wrap) wrap.style.display = rows.length ? "" : "none";
      const sel = `#${CSS.escape("{{ccd_tabulator_table}}")} .tabulator-paginator`;
      const pagination = document.querySelector(sel);
      if (pagination) pagination.style.display = (last_page > 1)? "" : "none";
      
      return { data: rows, last_page, last_row };
    },
  });

  window["plt_table"].on("renderComplete", function () {
    document.querySelectorAll(".tabulator-col-title").forEach(el => {
      el.classList.add("sm-text");
    });
  });
  const btn = document.getElementById("{{ccd_tabulator_table}}-download-csv");
    if (btn) {
    btn.addEventListener("click", () => {
        window["{{ccd_tabulator_table}}_table"]?.download(
        "csv",
        window["{{ccd_tabulator_table}}_filename"],
        { bom: true, downloadDataFormatter: (d) => d }
        );
    });
    }
}
</script>


<!-- PLT -->
